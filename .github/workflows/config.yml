name: XSOAR CI/CD
on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      DEMISTO_README_VALIDATION: "false"

    steps:
      - name: XSOAR CI/CD master checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Content checkout
        uses: actions/checkout@v4
        with:
          repository: demisto/content
          path: content

      - name: Install poetry
        uses: Gr1N/setup-poetry@v9

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: poetry

      - name: Install python dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction

      - name: Prepare Environment
        run: |
          mkdir -p "${GITHUB_WORKSPACE}/content/new_packs_zips"
          echo "NEW_PACKS_FOLDER=${GITHUB_WORKSPACE}/content/new_packs_zips" >> $GITHUB_ENV

          git -C "$GITHUB_WORKSPACE/content" fetch origin "${DEFAULT_BRANCH}" --prune

          PACKS_CHANGED=$(poetry run python "$GITHUB_WORKSPACE/build_related_scripts/get_modified_packs.py" \
            --repo_path "$GITHUB_WORKSPACE/content" \
            --prev-ver "origin/${DEFAULT_BRANCH}" | tr -d '\n')

          echo "PACKS_CHANGED=${PACKS_CHANGED}" >> $GITHUB_ENV
          echo "DEBUG: PACKS_CHANGED='${PACKS_CHANGED}'"


      - name: Prepare Venv
        run: |
          cd "$GITHUB_WORKSPACE/content/"

          # Install node packages (fase mantenida)
          npm install .

          git config diff.renameLimit 6000
          echo "========== Build Parameters =========="
          python --version
          # demisto-sdk desde Poetry (no depende de activate)
          cd "$GITHUB_WORKSPACE"
          poetry run demisto-sdk --version
          echo "====================================="

      - name: Create Packs Artifacts
        run: |
          if [ -n "$PACKS_CHANGED" ]; then
            # prepare-content crea los zips en NEW_PACKS_FOLDER
            poetry run demisto-sdk prepare-content --input "$PACKS_CHANGED" --output "$NEW_PACKS_FOLDER"
            echo "Artifacts generated at: $NEW_PACKS_FOLDER"
            ls -la "$NEW_PACKS_FOLDER" || true
          else
            echo "No packs has changed, skipping step. "
          fi

      - name: Install bucket upload deps
        run: |
          # Fase mantenida: si usas bucket_upload.py, necesita estas dependencias
          python -m pip install --upgrade pip prettytable google-cloud-storage

      - name: Upload Packs to Artifacts Server
        env:
          DEMISTO_BASE_URL: ${{ secrets.DEMISTO_BASE_URL }}
          DEMISTO_API_KEY: ${{ secrets.DEMISTO_API_KEY }}
          XSIAM_AUTH_ID: ${{ vars.XSIAM_AUTH_ID }}
        run: |
          if [ -n "$PACKS_CHANGED" ]; then
            if [ "$BRANCH_NAME" = "$DEFAULT_BRANCH" ]; then
              echo "Uploading artifacts ${PACKS_CHANGED}."
              echo "NEW_PACKS_FOLDER=$NEW_PACKS_FOLDER"
              ls -la "$NEW_PACKS_FOLDER" || { echo "Folder not found: $NEW_PACKS_FOLDER"; exit 1; }

              # 2) UPLOAD DIRECTLY TO YOUR XSOAR MACHINE
              for pack in "$NEW_PACKS_FOLDER"/*; do
                # evita intentar subir si no hay archivos
                [ -e "$pack" ] || { echo "No artifacts found to upload in $NEW_PACKS_FOLDER"; exit 0; }
                poetry run demisto-sdk upload --input "$pack"
              done

            else
              echo "The current branch is not the default branch, skipping upload to server."
            fi
          else
            echo "No packs has changed, skipping step."
          fi

